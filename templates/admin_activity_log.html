<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سجل العمليات</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Typing effect */
        @keyframes typing {
            from { width: 0; }
            to { width: 100%; }
        }

        @keyframes blink {
            50% { border-color: transparent; }
        }

        .typing-text {
            border-right: 3px solid #fbbf24;
            white-space: nowrap;
        }

        /* CTA Button */
        .cta-button {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .cta-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .cta-button:hover::before {
            left: 100%;
        }

        .cta-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        /* Glass effect */
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .typing-text {
                font-size: 1.5rem;
                line-height: 2rem;
            }
        }
    </style>
</head>
<body class="font-['Cairo'] bg-gradient-to-br from-blue-50 to-green-100 min-h-screen">
    <!-- Header & Hero Section -->
    <section class="relative bg-gradient-to-br from-gray-900 via-blue-900 to-indigo-900 text-white overflow-hidden">
        <!-- Background Pattern -->
        <div class="absolute inset-0 bg-black/20"></div>
        
        <!-- Header Navigation -->
        <div class="relative z-20">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-32 md:h-36 lg:h-40">
                    <!-- Right: Logo -->
                    <div class="flex items-center flex-shrink-0">
                        {% if school_settings and school_settings.school_logo %}
                            <img src="/assets/images/{{ school_settings.school_logo }}" alt="شعار المدرسة" class="h-24 md:h-28 lg:h-32 w-auto">
                        {% else %}
                            <img src="/assets/images/logo.png" alt="شعار المدرسة" class="h-24 md:h-28 lg:h-32 w-auto">
                        {% endif %}
                    </div>
                    <!-- Center: School Name (always visible) -->
                    <div class="flex-1 flex justify-center">
                        <span class="text-base md:text-3xl font-extrabold text-yellow-400 tracking-wide font-['Cairo','Noto Kufi Arabic',sans-serif] select-none">
                            {% if school_settings and school_settings.school_name %}
                                {{ school_settings.school_name }}
                            {% else %}
                                سجل بيانات المدرسة من الاعدادات
                            {% endif %}
                        </span>
                    </div>
                    <!-- Left: Navigation & Hamburger -->
                    <div class="flex items-center space-x-2 space-x-reverse">
                        <!-- Desktop Nav -->
                        <nav class="hidden md:flex items-center space-x-1 space-x-reverse mr-4">
                            <a href="/admin" class="px-3 py-2 rounded-md text-base font-medium text-white/90 hover:text-yellow-400 hover:bg-white/5 transition">لوحة التحكم</a>
                            <a href="/logout" class="px-3 py-2 rounded-md text-base font-medium text-white/90 hover:text-yellow-400 hover:bg-white/5 transition">تسجيل الخروج</a>
                        </nav>
                        <!-- Mobile menu button -->
                        <button onclick="toggleMobileMenu()" class="md:hidden flex items-center justify-center w-11 h-11 rounded-lg bg-white/10 text-white hover:bg-white/20 focus:outline-none focus:ring-2 focus:ring-white/50 transition" aria-label="فتح القائمة">
                            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile Navigation -->
        <div id="mobile-menu" class="hidden md:hidden bg-white/10 backdrop-blur-md border-t border-white/10 z-40 relative">
            <nav class="flex flex-col py-2 px-4 space-y-1">
                <a href="/admin" class="block px-3 py-2 rounded-md text-base font-medium text-white/90 hover:text-yellow-400 hover:bg-white/5 transition">لوحة التحكم</a>
                <a href="/logout" class="block px-3 py-2 rounded-md text-base font-medium text-white/90 hover:text-yellow-400 hover:bg-white/5 transition">تسجيل الخروج</a>
            </nav>
        </div>

        <!-- Hero Content -->
        <div class="relative z-10 pb-32">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-20">
                <div class="text-center">
                    <h1 class="text-4xl md:text-6xl font-bold mb-6 typing-text mt-16">
                        سجل العمليات
                    </h1>
                    <p class="text-xl md:text-2xl text-white/80 mb-8 max-w-3xl mx-auto mt-8">
                        مراقبة جميع العمليات التي تتم على النظام
                    </p>
                    <div class="flex justify-center">
                        <button class="cta-button bg-gradient-to-r from-yellow-400 to-orange-500 text-gray-900 px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transition-all duration-300">
                            عرض السجلات
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- أيقونة الرئيسية -->
    <div class="fixed left-4 top-1/2 transform -translate-y-1/2 z-50">
        <a href="/admin" class="bg-yellow-400 hover:bg-yellow-500 text-gray-900 p-3 rounded-full shadow-lg transition-all duration-300 hover:scale-110 hover:shadow-xl">
            <i class="fas fa-home text-xl"></i>
        </a>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="mb-6">
                    {% for category, message in messages %}
                        <div class="p-4 rounded-lg mb-2 {% if category == 'success' %}bg-green-100 text-green-800 border border-green-200{% elif category == 'danger' %}bg-red-100 text-red-800 border border-red-200{% elif category == 'warning' %}bg-yellow-100 text-yellow-800 border border-yellow-200{% else %}bg-blue-100 text-blue-800 border border-blue-200{% endif %}">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- Filters -->
        <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">فلاتر البحث</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div>
                    <label for="operation" class="block text-sm font-medium text-gray-700 mb-1">نوع العملية</label>
                    <select name="operation" id="operation" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">جميع العمليات</option>
                        <option value="إضافة" {% if request.args.get('operation') == 'إضافة' %}selected{% endif %}>إضافة</option>
                        <option value="تعديل" {% if request.args.get('operation') == 'تعديل' %}selected{% endif %}>تعديل</option>
                        <option value="حذف" {% if request.args.get('operation') == 'حذف' %}selected{% endif %}>حذف</option>
                    </select>
                </div>
                
                <div>
                    <label for="table" class="block text-sm font-medium text-gray-700 mb-1">الجدول</label>
                    <select name="table" id="table" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">جميع الجداول</option>
                        {% for table in tables %}
                        <option value="{{ table }}" {% if request.args.get('table') == table %}selected{% endif %}>{{ table }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label for="user" class="block text-sm font-medium text-gray-700 mb-1">المستخدم</label>
                    <select name="user" id="user" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">جميع المستخدمين</option>
                        {% for user in users %}
                        <option value="{{ user }}" {% if request.args.get('user') == user %}selected{% endif %}>{{ user }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label for="date" class="block text-sm font-medium text-gray-700 mb-1">التاريخ</label>
                    <input type="date" name="date" id="date" value="{{ request.args.get('date', '') }}" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="md:col-span-2 lg:col-span-4 flex justify-center space-x-4 space-x-reverse">
                    <a href="{{ url_for('admin_activity_log') }}" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        إعادة تعيين
                    </a>
                    <button onclick="clearAllLogs(event)" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-colors">
                        مسح جميع السجلات
                    </button>
                </div>
            </div>
        </div>

        <!-- Activity Log Table -->
        <div class="bg-white rounded-lg shadow-sm border overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">سجل العمليات</h2>
                <p class="text-sm text-gray-600 mt-1">إجمالي السجلات: {{ logs.total }}</p>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الرقم</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">نوع العملية</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الجدول</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المستخدم</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">التاريخ</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">التفاصيل</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for log in logs.items %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ log.id }}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full 
                                    {% if log.operation_type == 'إضافة' %}bg-green-100 text-green-800
                                    {% elif log.operation_type == 'تعديل' %}bg-yellow-100 text-yellow-800
                                    {% elif log.operation_type == 'حذف' %}bg-red-100 text-red-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ log.operation_type }}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ log.table_name }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                {% if log.user_name %}
                                    {{ log.user_name }}
                                    {% if log.user_civil_id %}
                                        <br><span class="text-xs text-gray-500">{{ log.user_civil_id }}</span>
                                    {% endif %}
                                {% else %}
                                    <span class="text-gray-400">غير محدد</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                {{ log.created_at.strftime('%Y-%m-%d %H:%M') }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                <button data-log-id="{{ log.id }}" class="show-log-details-btn text-blue-600 hover:text-blue-800 font-medium">
                                    عرض التفاصيل
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            {% if logs.pages > 1 %}
            <div class="bg-white px-4 py-3 border-t border-gray-200 sm:px-6">
                <div class="flex items-center justify-between">
                    <div class="flex-1 flex justify-between sm:hidden">
                        {% if logs.has_prev %}
                        <a href="{{ url_for('admin_activity_log', page=logs.prev_num, operation=request.args.get('operation'), table=request.args.get('table'), user=request.args.get('user'), date=request.args.get('date')) }}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            السابق
                        </a>
                        {% endif %}
                        {% if logs.has_next %}
                        <a href="{{ url_for('admin_activity_log', page=logs.next_num, operation=request.args.get('operation'), table=request.args.get('table'), user=request.args.get('user'), date=request.args.get('date')) }}" class="mr-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            التالي
                        </a>
                        {% endif %}
                    </div>
                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                        <div>
                            <p class="text-sm text-gray-700">
                                عرض <span class="font-medium">{{ logs.items|length }}</span> من <span class="font-medium">{{ logs.total }}</span> نتيجة
                            </p>
                        </div>
                        <div>
                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                                {% if logs.has_prev %}
                                <a href="{{ url_for('admin_activity_log', page=logs.prev_num, operation=request.args.get('operation'), table=request.args.get('table'), user=request.args.get('user'), date=request.args.get('date')) }}" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                    السابق
                                </a>
                                {% endif %}
                                
                                {% for page_num in logs.iter_pages() %}
                                    {% if page_num %}
                                        {% if page_num != logs.page %}
                                        <a href="{{ url_for('admin_activity_log', page=page_num, operation=request.args.get('operation'), table=request.args.get('table'), user=request.args.get('user'), date=request.args.get('date')) }}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                                            {{ page_num }}
                                        </a>
                                        {% else %}
                                        <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-blue-50 text-sm font-medium text-blue-600">
                                            {{ page_num }}
                                        </span>
                                        {% endif %}
                                    {% else %}
                                    <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                                        ...
                                    </span>
                                    {% endif %}
                                {% endfor %}
                                
                                {% if logs.has_next %}
                                <a href="{{ url_for('admin_activity_log', page=logs.next_num, operation=request.args.get('operation'), table=request.args.get('table'), user=request.args.get('user'), date=request.args.get('date')) }}" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                    التالي
                                </a>
                                {% endif %}
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Log Details Modal -->
    <div id="logDetailsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-6 border w-11/12 md:w-4/5 lg:w-3/4 xl:w-2/3 shadow-lg rounded-lg bg-white max-h-[90vh] overflow-y-auto">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-900">تفاصيل العملية</h3>
                    <button onclick="closeLogDetails()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Loading Spinner -->
                <div id="loadingSpinner" class="flex justify-center items-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    <span class="mr-3 text-gray-600">جاري التحميل...</span>
                </div>
                
                <!-- Error Message -->
                <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                    <span id="errorText"></span>
                </div>
                
                <!-- Content -->
                <div id="logDetailsContent" class="hidden">
                    <!-- Basic Information -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">المعلومات الأساسية</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <span class="font-medium text-gray-700">رقم العملية:</span>
                                <span id="logId" class="text-gray-900"></span>
                            </div>
                            <div>
                                <span class="font-medium text-gray-700">نوع العملية:</span>
                                <span id="operationType" class="inline-flex px-2 py-1 text-xs font-semibold rounded-full"></span>
                            </div>
                            <div>
                                <span class="font-medium text-gray-700">الجدول:</span>
                                <span id="tableName" class="text-gray-900"></span>
                            </div>
                            <div>
                                <span class="font-medium text-gray-700">معرف السجل:</span>
                                <span id="recordId" class="text-gray-900"></span>
                            </div>
                            <div>
                                <span class="font-medium text-gray-700">التاريخ والوقت:</span>
                                <span id="createdAt" class="text-gray-900"></span>
                            </div>
                            <div>
                                <span class="font-medium text-gray-700">عنوان IP:</span>
                                <span id="ipAddress" class="text-gray-900"></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- User Information -->
                    <div class="bg-blue-50 rounded-lg p-4 mb-6">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">معلومات المستخدم</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <span class="font-medium text-gray-700">الاسم:</span>
                                <span id="userName" class="text-gray-900"></span>
                            </div>
                            <div>
                                <span class="font-medium text-gray-700">الرقم المدني:</span>
                                <span id="userCivilId" class="text-gray-900"></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Description -->
                    <div id="descriptionSection" class="bg-yellow-50 rounded-lg p-4 mb-6 hidden">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">وصف العملية</h4>
                        <p id="description" class="text-gray-900"></p>
                    </div>
                    
                    <!-- Old Data (for modifications) -->
                    <div id="oldDataSection" class="bg-red-50 rounded-lg p-4 mb-6 hidden">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">البيانات القديمة</h4>
                        <div id="oldData" class="bg-white rounded border p-3 max-h-64 overflow-y-auto"></div>
                    </div>
                    
                    <!-- New Data -->
                    <div id="newDataSection" class="bg-green-50 rounded-lg p-4 mb-6 hidden">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">البيانات الجديدة</h4>
                        <div id="newData" class="bg-white rounded border p-3 max-h-64 overflow-y-auto"></div>
                    </div>
                    

                </div>
            </div>
        </div>
    </div>

    <script>
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobile-menu');
            mobileMenu.classList.toggle('hidden');
        }

        function showLogDetails(logId) {
            // إظهار Modal مع Loading
            document.getElementById('logDetailsModal').classList.remove('hidden');
            document.getElementById('loadingSpinner').classList.remove('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('logDetailsContent').classList.add('hidden');
            
            // جلب تفاصيل العملية من الخادم
            fetch(`/admin/activity_log/${logId}/details`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('فشل في جلب البيانات');
                    }
                    return response.json();
                })
                .then(data => {
                    // إخفاء Loading وإظهار المحتوى
                    document.getElementById('loadingSpinner').classList.add('hidden');
                    document.getElementById('logDetailsContent').classList.remove('hidden');
                    
                    // ملء البيانات الأساسية
                    document.getElementById('logId').textContent = data.id;
                    document.getElementById('tableName').textContent = data.table_name;
                    document.getElementById('recordId').textContent = data.record_id || 'غير محدد';
                    document.getElementById('createdAt').textContent = data.created_at;
                    document.getElementById('ipAddress').textContent = data.ip_address || 'غير محدد';
                    
                    // نوع العملية مع اللون المناسب
                    const operationTypeElement = document.getElementById('operationType');
                    operationTypeElement.textContent = data.operation_type;
                    operationTypeElement.className = 'inline-flex px-2 py-1 text-xs font-semibold rounded-full';
                    
                    if (data.operation_type === 'إضافة') {
                        operationTypeElement.classList.add('bg-green-100', 'text-green-800');
                    } else if (data.operation_type === 'تعديل') {
                        operationTypeElement.classList.add('bg-yellow-100', 'text-yellow-800');
                    } else if (data.operation_type === 'حذف') {
                        operationTypeElement.classList.add('bg-red-100', 'text-red-800');
                    } else {
                        operationTypeElement.classList.add('bg-gray-100', 'text-gray-800');
                    }
                    
                    // معلومات المستخدم
                    document.getElementById('userName').textContent = data.user_info.name || 'غير محدد';
                    document.getElementById('userCivilId').textContent = data.user_info.civil_id || 'غير محدد';
                    
                    // وصف العملية
                    if (data.description) {
                        document.getElementById('descriptionSection').classList.remove('hidden');
                        document.getElementById('description').textContent = data.description;
                    } else {
                        document.getElementById('descriptionSection').classList.add('hidden');
                    }
                    
                    // البيانات القديمة (للعمليات من نوع تعديل)
                    if (data.old_data && Object.keys(data.old_data).length > 0) {
                        document.getElementById('oldDataSection').classList.remove('hidden');
                        document.getElementById('oldData').innerHTML = formatDataForDisplay(data.old_data);
                    } else {
                        document.getElementById('oldDataSection').classList.add('hidden');
                    }
                    
                    // البيانات الجديدة
                    if (data.new_data && Object.keys(data.new_data).length > 0) {
                        document.getElementById('newDataSection').classList.remove('hidden');
                        document.getElementById('newData').innerHTML = formatDataForDisplay(data.new_data);
                    } else {
                        document.getElementById('newDataSection').classList.add('hidden');
                    }
                    

                })
                .catch(error => {
                    // إظهار رسالة الخطأ
                    document.getElementById('loadingSpinner').classList.add('hidden');
                    document.getElementById('errorMessage').classList.remove('hidden');
                    document.getElementById('errorText').textContent = `حدث خطأ: ${error.message}`;
                });
        }
        
        function formatDataForDisplay(data) {
            if (typeof data === 'object' && data !== null) {
                let html = '<div class="space-y-2">';
                for (const [key, value] of Object.entries(data)) {
                    const displayKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    const displayValue = typeof value === 'object' ? JSON.stringify(value, null, 2) : String(value);
                    
                    html += `
                        <div class="border-b border-gray-200 pb-2">
                            <div class="font-medium text-gray-700 mb-1">${displayKey}:</div>
                            <div class="text-gray-900 text-sm bg-gray-50 p-2 rounded break-all">${displayValue}</div>
                        </div>
                    `;
                }
                html += '</div>';
                return html;
            } else {
                return `<div class="text-gray-900">${String(data)}</div>`;
            }
        }

        function closeLogDetails() {
            document.getElementById('logDetailsModal').classList.add('hidden');
            // إعادة تعيين حالة Modal
            document.getElementById('loadingSpinner').classList.add('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('logDetailsContent').classList.add('hidden');
        }

        // Close modal when clicking outside
        document.getElementById('logDetailsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeLogDetails();
            }
        });

        // Auto-apply filters when selection changes
        function applyFilters() {
            const operation = document.getElementById('operation').value;
            const table = document.getElementById('table').value;
            const user = document.getElementById('user').value;
            const date = document.getElementById('date').value;
            
            const params = new URLSearchParams();
            if (operation) params.append('operation', operation);
            if (table) params.append('table', table);
            if (user) params.append('user', user);
            if (date) params.append('date', date);
            
            const url = '{{ url_for("admin_activity_log") }}' + (params.toString() ? '?' + params.toString() : '');
            window.location.href = url;
        }

        // Add event listeners for auto-filtering and log details buttons
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners for filter controls
            document.getElementById('operation').addEventListener('change', applyFilters);
            document.getElementById('table').addEventListener('change', applyFilters);
            document.getElementById('user').addEventListener('change', applyFilters);
            document.getElementById('date').addEventListener('change', applyFilters);
            
            // Add event listeners for log details buttons
            const logDetailsButtons = document.querySelectorAll('.show-log-details-btn');
            logDetailsButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const logId = this.getAttribute('data-log-id');
                    showLogDetails(logId);
                });
            });
        });

        // Function to clear all activity logs
        function clearAllLogs(event) {
            // Show confirmation dialog
            const confirmed = confirm('هل أنت متأكد من رغبتك في مسح جميع سجلات العمليات؟\n\nهذا الإجراء لا يمكن التراجع عنه!');
            
            if (confirmed) {
                // Show loading state
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'جاري المسح...';
                button.disabled = true;
                button.classList.add('opacity-50');
                
                // Send request to clear all logs
                fetch('/admin/activity_log/clear_all', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('فشل في مسح السجلات');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Show success message and reload page
                        alert('تم مسح جميع سجلات العمليات بنجاح');
                        window.location.reload();
                    } else {
                        throw new Error(data.message || 'حدث خطأ أثناء مسح السجلات');
                    }
                })
                .catch(error => {
                    // Show error message
                    alert('خطأ: ' + error.message);
                    
                    // Reset button state
                    button.textContent = originalText;
                    button.disabled = false;
                    button.classList.remove('opacity-50');
                });
            }
        }
    </script>
</body>
</html> 